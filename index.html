<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Siesta Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

    <div class="max-w-5xl mx-auto bg-white p-6 rounded shadow space-y-6">
        <div class="flex justify-between items-center">
            <h1 id="titlePage" class="text-xl font-bold">Seguimiento de siestas</h1>
            <div class="flex items-center space-x-4">
                <!-- User info and login/logout -->
                <div id="userInfo" class="flex items-center space-x-2 hidden">
                    <span id="userName" class="text-sm text-gray-700"></span>
                    <button id="logoutBtn" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">
                        <span id="logoutText">Cerrar sesi√≥n</span>
                    </button>
                </div>
                <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center space-x-2">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span id="loginText">Iniciar con Google</span>
                </button>
                <select id="languageSelect" class="border border-gray-300 rounded px-2 py-1 w-32">
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="en">üá¨üáß English</option>
                </select>
            </div>
        </div>

        <!-- Authentication required message -->
        <div id="authRequired" class="text-center py-8 hidden">
            <p id="authRequiredText" class="text-gray-600 mb-4">Inicia sesi√≥n con tu cuenta de Google para acceder a tus datos</p>
        </div>

        <!-- Tab navigation - always visible -->
        <div class="flex border-b">
            <button id="tabBtnNext"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-blue-600 text-blue-600 hover:bg-gray-100"
                data-tab="nextSiesta">Pr√≥xima siesta</button>
            <button id="tabBtnInsert"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-transparent hover:bg-gray-100"
                data-tab="insertar">Insertar</button>
            <button id="tabBtnHist"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-transparent hover:bg-gray-100"
                data-tab="historico">Hist√≥rico</button>
            <button id="tabBtnGraph"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-transparent hover:bg-gray-100"
                data-tab="grafica">Gr√°fica</button>
            <button id="tabBtnConfig"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-transparent hover:bg-gray-100"
                data-tab="config">Config</button>
        </div>

        <!-- Config tab - always visible -->
        <div id="tab-config" class="tab-content hidden">
            <div class="mb-4 p-3 rounded bg-gray-50 border">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">Estado de conexi√≥n Firebase:</span>
                    <span id="connectionStatus" class="text-sm px-2 py-1 rounded">Verificando...</span>
                </div>
            </div>
            <label id="labelConfig" class="block text-sm font-medium text-gray-700 mb-2">Configuraci√≥n de Firebase
                (JSON)</label>
            <textarea hidden id="firebaseConfig" rows="8"
                class="w-full rounded border-2 border-gray-300 shadow-sm p-3 mb-4 font-mono text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder='{\n  "apiKey": "AIzaSyCVSLDNktqvmm-gjl0P1BTjJrUpq1bmXDo",\n  "authDomain": "baby-sleep-tracker-725d1.firebaseapp.com",\n  "projectId": "baby-sleep-tracker-725d1",\n  "storageBucket": "baby-sleep-tracker-725d1.firebasestorage.app",\n  "messagingSenderId": "451610840660",\n  "appId": "1:451610840660:web:a4c3266cc8dd4ca37927c1"\n}'></textarea>
            <button hidden id="saveConfigBtn"
                class="w-full px-4 py-2 rounded bg-green-600 text-white font-medium hover:bg-green-700 transition">Guardar
                configuraci√≥n</button>
            <p id="saveMessage" class="text-sm mt-2"></p>
        </div>

        <!-- Main content - only visible when authenticated -->
        <div id="mainContent" class="hidden">
            <!-- Next Siesta -->
            <div id="tab-nextSiesta" class="tab-content">
                <p id="contentNext">Pr√≥xima siesta aqu√≠‚Ä¶</p>
            </div>

            <!-- History -->
            <div id="tab-historico" class="tab-content hidden">
                <div class="flex space-x-2 mb-4">
                    <label class="text-sm">Desde: <input type="date" id="histFrom" class="border rounded p-1" /></label>
                    <label class="text-sm">Hasta: <input type="date" id="histTo" class="border rounded p-1" /></label>
                    <button id="loadHistBtn" class="px-2 py-1 bg-gray-200 rounded">Cargar</button>
                </div>
                <div id="contentHist" class="overflow-auto max-h-64 bg-gray-50 p-2 rounded">Hist√≥rico aqu√≠‚Ä¶</div>
            </div>

            <!-- Graph -->
            <div id="tab-grafica" class="tab-content hidden">
                <div class="flex space-x-2 mb-4">
                    <label class="text-sm">Desde: <input type="date" id="graphFrom" class="border rounded p-1" /></label>
                    <label class="text-sm">Hasta: <input type="date" id="graphTo" class="border rounded p-1" /></label>
                    <button id="loadGraphBtn" class="px-2 py-1 bg-gray-200 rounded">Cargar</button>
                </div>
                <canvas id="sleepChart"></canvas>
            </div>

            <!-- Insert -->
            <div id="tab-insertar" class="tab-content space-y-4 hidden">
                <form id="sleepForm" class="space-y-4">
                    <div>
                        <label id="labelNacimiento" class="block text-sm font-medium text-gray-700">Fecha de nacimiento del beb√©</label>
                        <input type="date" id="birthDate" required
                            class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
                    </div>
                    <div>
                        <label id="labelFecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="napDate" required
                            class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
                    </div>
                    <div>
                        <label id="labelInicio" class="block text-sm font-medium text-gray-700">Hora inicio siesta</label>
                        <input type="time" id="napStart" required
                            class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
                    </div>
                    <div>
                        <label id="labelFin" class="block text-sm font-medium text-gray-700">Hora fin siesta</label>
                        <input type="time" id="napEnd" required
                            class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
                    </div>
                    <div>
                        <label id="labelComentarios" class="block text-sm font-medium text-gray-700">Comentarios</label>
                        <textarea id="comments" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></textarea>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="goodWake" class="mr-2">
                        <label id="labelDesperto" for="goodWake" class="text-sm text-gray-700">Despert√≥ bien</label>
                    </div>
                    <button type="submit" id="btnGuardar"
                        class="px-4 py-2 rounded bg-blue-600 text-white font-medium hover:bg-blue-700 transition">Guardar</button>
                    <p id="formMessage" class="text-sm mt-2"></p>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentLang = 'es';

        // Authentication functions
        function initializeAuth() {
            if (!firebase.apps.length || !firebase.auth) {
                console.log('Firebase not initialized or Auth not available');
                return;
            }

            firebase.auth().onAuthStateChanged((user) => {
                currentUser = user;
                updateAuthUI();
                if (user) {
                    // User is signed in
                    console.log('User signed in:', user.displayName);
                    showMainContent();
                    // Load user data
                    setTimeout(() => {
                        calcularProximaSiestaPonderada();
                        loadHistorico();
                        loadGraph();
                    }, 500);
                } else {
                    // User is signed out
                    console.log('User signed out');
                    hideMainContent();
                }
            });
        }

        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const authRequired = document.getElementById('authRequired');

            if (currentUser) {
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                authRequired.classList.add('hidden');
                
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                
                // Show main content
                showMainContent();
            } else {
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                
                // Check if current tab is protected
                const activeTab = document.querySelector('.tab-btn.border-blue-600');
                const protectedTabs = ['nextSiesta', 'insertar', 'historico', 'grafica'];
                
                if (activeTab && protectedTabs.includes(activeTab.dataset.tab)) {
                    authRequired.classList.remove('hidden');
                } else {
                    authRequired.classList.add('hidden');
                }
                
                // Hide main content
                hideMainContent();
            }
        }

        function showMainContent() {
            document.getElementById('mainContent').classList.remove('hidden');
        }

        function hideMainContent() {
            document.getElementById('mainContent').classList.add('hidden');
        }

        async function signInWithGoogle() {
            try {
                if (!firebase.apps.length || !firebase.auth) {
                    alert(currentLang === 'es' ? 'Por favor, configura Firebase primero en la pesta√±a Config' : 'Please configure Firebase first in the Config tab');
                    return;
                }
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                
                const result = await firebase.auth().signInWithPopup(provider);
                console.log('Sign in successful:', result.user.displayName);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Error al iniciar sesi√≥n: ' + error.message);
            }
        }

        async function signOut() {
            try {
                if (!firebase.apps.length || !firebase.auth) {
                    console.log('Firebase not available for sign out');
                    return;
                }
                await firebase.auth().signOut();
                console.log('Sign out successful');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Add user validation for all data operations
        function validateUserAuth() {
            if (!currentUser) {
                throw new Error(translations[currentLang]?.userNotAuth || 'User not authenticated');
            }
            if (!window.firestoreDB) {
                throw new Error(translations[currentLang]?.noConnection || 'No Firebase connection');
            }
        }

        // Modify data access functions to be user-specific
        function getUserCollection(collectionName) {
            validateUserAuth();
            return window.firestoreDB.collection('users').doc(currentUser.uid).collection(collectionName);
        }

        // Update sleep form logic with better security
        const sleepForm = document.getElementById('sleepForm');
        if (sleepForm) {
            sleepForm.addEventListener('submit', async e => {
                e.preventDefault();
                const formMsg = document.getElementById('formMessage');
                formMsg.textContent = '';
                formMsg.className = 'text-sm mt-2'; // Reset classes
                
                try {
                    validateUserAuth();
                    
                    const birthDate = document.getElementById('birthDate').value;
                    const date = document.getElementById('napDate').value;
                    const start = document.getElementById('napStart').value;
                    const end = document.getElementById('napEnd').value;
                    
                    // Save birth date to user-specific storage
                    localStorage.setItem(`babyBirthDate_${currentUser.uid}`, birthDate);
                    
                    // Calculate age in weeks
                    const birthDateTime = new Date(birthDate);
                    const napDateTime = new Date(date);
                    const ageInDays = Math.floor((napDateTime - birthDateTime) / (1000 * 60 * 60 * 24));
                    const ageInWeeks = Math.floor(ageInDays / 7);
                    
                    if (new Date(`1970-01-01T${end}`) <= new Date(`1970-01-01T${start}`)) {
                        throw new Error(translations[currentLang].timeError);
                    }
                    const commentsVal = document.getElementById('comments').value;
                    const good = document.getElementById('goodWake').checked;
                    
                    // Save to user's collection with explicit user verification
                    const recordData = { 
                        birthDate, 
                        date, 
                        start, 
                        end, 
                        comments: commentsVal, 
                        goodWake: good, 
                        ageInWeeks,
                        timestamp: new Date(),
                        userId: currentUser.uid // Explicit user ID for double verification
                    };
                    
                    await getUserCollection('sleepRecords').add(recordData);
                    
                    formMsg.textContent = translations[currentLang].dataSaved;
                    formMsg.classList.add('text-green-600');
                    sleepForm.reset();
                    setDefaultValues();
                    calcularProximaSiestaPonderada();
                    loadHistorico();
                    loadGraph();
                } catch (err) {
                    console.error('Error saving sleep record:', err);
                    formMsg.textContent = '‚ùå ' + err.message;
                    formMsg.classList.add('text-red-600');
                }
            });
        }

        // Function to set default values with user-specific data
        function setDefaultValues() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            // Current time
            const currentHours = String(now.getHours()).padStart(2, '0');
            const currentMinutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${currentHours}:${currentMinutes}`;

            // 30 minutes ago
            const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);
            const startHours = String(thirtyMinutesAgo.getHours()).padStart(2, '0');
            const startMinutes = String(thirtyMinutesAgo.getMinutes()).padStart(2, '0');
            const startTime = `${startHours}:${startMinutes}`;

            // Set birth date default (load from user-specific localStorage)
            const userKey = currentUser ? `babyBirthDate_${currentUser.uid}` : 'babyBirthDate_guest';
            const savedBirthDate = localStorage.getItem(userKey) || '2025-04-19';
            document.getElementById('birthDate').value = savedBirthDate;

            // Set insert form defaults
            document.getElementById('napDate').value = today;
            document.getElementById('napStart').value = startTime;
            document.getElementById('napEnd').value = currentTime;

            // Set historical dates (yesterday to today)
            document.getElementById('histFrom').value = yesterday;
            document.getElementById('histTo').value = today;

            // Set graph dates (yesterday to today)
            document.getElementById('graphFrom').value = yesterday;
            document.getElementById('graphTo').value = today;
        }

        // Tab navigation by data-tab
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(btn => {
            btn.addEventListener('click', () => {
                // deactivate all
                tabs.forEach(b => {
                    b.classList.remove('border-blue-600', 'text-blue-600');
                    b.classList.add('text-gray-700', 'border-transparent');
                });
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                
                // activate clicked
                btn.classList.remove('text-gray-700', 'border-transparent');
                btn.classList.add('border-blue-600', 'text-blue-600');
                const target = document.getElementById(`tab-${btn.dataset.tab}`);
                if (target) target.classList.remove('hidden');
                
                // Show auth required message for protected tabs when not authenticated
                const authRequired = document.getElementById('authRequired');
                const protectedTabs = ['nextSiesta', 'insertar', 'historico', 'grafica'];
                
                if (!currentUser && protectedTabs.includes(btn.dataset.tab)) {
                    authRequired.classList.remove('hidden');
                } else {
                    authRequired.classList.add('hidden');
                }
            });
        });

        // Actual data loading functions with security validation
        async function calcularProximaSiestaPonderada() {
            const contentNext = document.getElementById('contentNext');
            const lang = translations[currentLang];
            
            try {
                validateUserAuth();
                
                contentNext.textContent = lang.calculating;
                
                // Get saved birth date (user-specific)
                const userKey = `babyBirthDate_${currentUser.uid}`;
                const savedBirthDate = localStorage.getItem(userKey);
                
                if (!savedBirthDate) {
                    contentNext.innerHTML = `
                        <div class="space-y-2">
                            <p class="text-orange-600">${currentLang === 'es' ? 'Por favor, ingresa la fecha de nacimiento del beb√© en la pesta√±a Insertar' : 'Please enter the baby\'s birth date in the Insert tab'}</p>
                        </div>
                    `;
                    return;
                }
                
                const birthDateTime = new Date(savedBirthDate);
                const now = new Date();
                const currentAgeInWeeks = Math.floor((now - birthDateTime) / (1000 * 60 * 60 * 24 * 7));
                
                // Get last 10 nap records from user's collection only
                const snapshot = await getUserCollection('sleepRecords')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    contentNext.innerHTML = `
                        <div class="space-y-2">
                            <p class="text-sm text-gray-600">${currentLang === 'es' ? 'Edad actual' : 'Current age'}: ${currentAgeInWeeks} ${currentLang === 'es' ? 'semanas' : 'weeks'}</p>
                            <p>${lang.noData}</p>
                        </div>
                    `;
                    return;
                }
                
                let totalMinutes = 0;
                let count = 0;
                let lastNapTime = null;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Double-check user ownership for extra security
                    if (data.userId && data.userId !== currentUser.uid) {
                        console.warn('Data belongs to different user, skipping');
                        return;
                    }
                    
                    const start = new Date(`1970-01-01T${data.start}`);
                    const end = new Date(`1970-01-01T${data.end}`);
                    const duration = (end - start) / (1000 * 60); // minutes
                    
                    totalMinutes += duration;
                    count++;
                    
                    if (!lastNapTime) {
                        lastNapTime = new Date(`${data.date}T${data.end}`);
                    }
                });
                
                if (count === 0) {
                    contentNext.innerHTML = `
                        <div class="space-y-2">
                            <p class="text-sm text-gray-600">${currentLang === 'es' ? 'Edad actual' : 'Current age'}: ${currentAgeInWeeks} ${currentLang === 'es' ? 'semanas' : 'weeks'}</p>
                            <p>${lang.noData}</p>
                        </div>
                    `;
                    return;
                }
                
                const avgDuration = Math.round(totalMinutes / count);
                const avgHours = Math.floor(avgDuration / 60);
                const avgMins = avgDuration % 60;
                
                // Calculate next nap time based on age
                let napInterval = 3.5; // default for older babies
                
                if (currentAgeInWeeks <= 4) {
                    napInterval = 1.5; // Newborn: every 1.5 hours
                } else if (currentAgeInWeeks <= 12) {
                    napInterval = 2; // 1-3 months: every 2 hours
                } else if (currentAgeInWeeks <= 26) {
                    napInterval = 2.5; // 3-6 months: every 2.5 hours
                } else if (currentAgeInWeeks <= 52) {
                    napInterval = 3; // 6-12 months: every 3 hours
                }
                
                const nextNapTime = new Date(lastNapTime.getTime() + (napInterval * 60 * 60 * 1000));
                const nextNapFormatted = nextNapTime.toLocaleTimeString(currentLang === 'es' ? 'es-ES' : 'en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Calculate time until next nap
                const timeUntilNap = nextNapTime - now;
                const hoursUntil = Math.floor(timeUntilNap / (1000 * 60 * 60));
                const minutesUntil = Math.floor((timeUntilNap % (1000 * 60 * 60)) / (1000 * 60));
                
                let timeUntilText = '';
                if (timeUntilNap > 0) {
                    if (hoursUntil > 0) {
                        timeUntilText = `${hoursUntil}h ${minutesUntil}m`;
                    } else {
                        timeUntilText = `${minutesUntil}m`;
                    }
                    timeUntilText = currentLang === 'es' ? `en ${timeUntilText}` : `in ${timeUntilText}`;
                } else {
                    timeUntilText = currentLang === 'es' ? '¬°Ya es hora!' : 'It\'s time!';
                }
                
                contentNext.innerHTML = `
                    <div class="space-y-2">
                        <p class="text-sm text-gray-600">${currentLang === 'es' ? 'Edad actual' : 'Current age'}: ${currentAgeInWeeks} ${currentLang === 'es' ? 'semanas' : 'weeks'}</p>
                        <p><strong>${currentLang === 'es' ? 'Duraci√≥n promedio' : 'Average duration'}:</strong> ${avgHours}h ${avgMins}m</p>
                        <p><strong>${currentLang === 'es' ? 'Pr√≥xima siesta estimada' : 'Next estimated nap'}:</strong> ${nextNapFormatted} (${timeUntilText})</p>
                        <p class="text-sm text-gray-600">${currentLang === 'es' ? 'Basado en los √∫ltimos 10 registros y edad del beb√©' : 'Based on last 10 records and baby\'s age'}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error calculating next nap:', error);
                contentNext.textContent = `Error: ${error.message}`;
            }
        }

        async function loadHistorico() {
            const contentHist = document.getElementById('contentHist');
            const lang = translations[currentLang];
            
            try {
                validateUserAuth();
                
                contentHist.innerHTML = `<div class="text-center py-8 text-gray-600">${lang.loading}</div>`;
                
                const fromDate = document.getElementById('histFrom').value;
                const toDate = document.getElementById('histTo').value;
                
                let query = getUserCollection('sleepRecords')
                    .orderBy('timestamp', 'desc');
                
                if (fromDate && toDate) {
                    const fromTimestamp = new Date(`${fromDate}T00:00:00`);
                    const toTimestamp = new Date(`${toDate}T23:59:59`);
                    query = query.where('timestamp', '>=', fromTimestamp)
                                 .where('timestamp', '<=', toTimestamp);
                }
                
                const snapshot = await query.limit(50).get();
                
                if (snapshot.empty) {
                    contentHist.innerHTML = `<div class="text-center py-8 text-gray-600">${lang.noData}</div>`;
                    return;
                }
                
                // Create table with headers
                let html = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.date}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.time}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.duration}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.ageWeeks}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.goodWake}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.comments}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.actions}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                `;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Double-check user ownership for extra security
                    if (data.userId && data.userId !== currentUser.uid) {
                        console.warn('Data belongs to different user, skipping');
                        return;
                    }
                    
                    const start = new Date(`1970-01-01T${data.start}`);
                    const end = new Date(`1970-01-01T${data.end}`);
                    const duration = Math.round((end - start) / (1000 * 60)); // minutes
                    const hours = Math.floor(duration / 60);
                    const mins = duration % 60;
                    
                    // Calculate age if birth date is available
                    let ageText = data.ageInWeeks ? `${data.ageInWeeks}` : '-';
                    if (!data.ageInWeeks && data.birthDate) {
                        const birthDateTime = new Date(data.birthDate);
                        const napDateTime = new Date(data.date);
                        const ageInDays = Math.floor((napDateTime - birthDateTime) / (1000 * 60 * 60 * 24));
                        const ageInWeeks = Math.floor(ageInDays / 7);
                        ageText = `${ageInWeeks}`;
                    }
                    
                    const goodWakeText = data.goodWake ? lang.wokeUpWell : lang.wokeUpBad;
                    const goodWakeClass = data.goodWake ? 'text-green-600' : 'text-red-600';
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 text-sm font-medium text-gray-900">${data.date}</td>
                            <td class="px-3 py-2 text-sm text-gray-700">${data.start} - ${data.end}</td>
                            <td class="px-3 py-2 text-sm text-gray-700">${hours}h ${mins}m</td>
                            <td class="px-3 py-2 text-sm text-gray-700">${ageText}</td>
                            <td class="px-3 py-2 text-sm ${goodWakeClass}">${goodWakeText}</td>
                            <td class="px-3 py-2 text-sm text-gray-600">${data.comments || '-'}</td>
                            <td class="px-3 py-2 text-sm">
                                <button onclick="deleteRecord('${doc.id}')" 
                                    class="text-red-600 hover:text-red-800 text-xs px-2 py-1 border border-red-300 rounded hover:bg-red-50 transition"
                                    title="${lang.deleteRecord}">
                                    üóëÔ∏è ${lang.delete}
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                contentHist.innerHTML = html;
            } catch (error) {
                console.error('Error loading history:', error);
                contentHist.innerHTML = `<div class="text-center py-8 text-red-600">Error: ${error.message}</div>`;
            }
        }

        // Delete record function with security validation
        async function deleteRecord(docId) {
            const lang = translations[currentLang];
            
            if (!confirm(lang.confirmDelete)) {
                return;
            }
            
            try {
                validateUserAuth();
                
                // First verify the record belongs to the current user
                const doc = await getUserCollection('sleepRecords').doc(docId).get();
                
                if (!doc.exists) {
                    throw new Error(lang.recordNotFound || 'Record not found');
                }
                
                const data = doc.data();
                if (data.userId && data.userId !== currentUser.uid) {
                    throw new Error(lang.accessDenied || 'Access denied');
                }
                
                await getUserCollection('sleepRecords').doc(docId).delete();
                
                // Reload data after deletion
                loadHistorico();
                calcularProximaSiestaPonderada();
                loadGraph();
                
                // Show success message temporarily
                const contentHist = document.getElementById('contentHist');
                const tempMessage = document.createElement('div');
                tempMessage.className = 'text-green-600 text-sm mb-2';
                tempMessage.textContent = lang.recordDeleted;
                contentHist.parentNode.insertBefore(tempMessage, contentHist);
                
                setTimeout(() => {
                    if (tempMessage.parentNode) {
                        tempMessage.parentNode.removeChild(tempMessage);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error deleting record:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function loadGraph() {
            const canvas = document.getElementById('sleepChart');
            const lang = translations[currentLang];
            
            if (!canvas) return;
            
            const chartContainer = canvas.parentElement;
            
            if (!window.firestoreDB || !currentUser) {
                canvas.style.display = 'none';
                chartContainer.innerHTML = `
                    <div class="flex space-x-2 mb-4">
                        <label class="text-sm">${lang.from} <input type="date" id="graphFrom" class="border rounded p-1" /></label>
                        <label class="text-sm">${lang.to} <input type="date" id="graphTo" class="border rounded p-1" /></label>
                        <button id="loadGraphBtn" class="px-2 py-1 bg-gray-200 rounded">${lang.load}</button>
                    </div>
                    <div class="text-center py-8 text-gray-600">${lang.noConnection}</div>
                    <canvas id="sleepChart" style="display: none;"></canvas>
                `;
                // Re-attach event listener
                document.getElementById('loadGraphBtn').addEventListener('click', loadGraph);
                return;
            }
            
            // Show loading message
            canvas.style.display = 'none';
            const loadingDiv = chartContainer.querySelector('.text-center') || document.createElement('div');
            loadingDiv.className = 'text-center py-8 text-gray-600';
            loadingDiv.textContent = lang.loading;
            if (!chartContainer.querySelector('.text-center')) {
                chartContainer.appendChild(loadingDiv);
            }
            
            const ctx = canvas.getContext('2d');
            // Clear previous chart if exists
            if (window.sleepChartInstance) {
                window.sleepChartInstance.destroy();
            }
            
            // Load real data
            loadGraphData().then(data => {
                if (data.labels.length === 0) {
                    // Hide canvas and show no data message
                    canvas.style.display = 'none';
                    loadingDiv.textContent = lang.noData;
                    return;
                }
                
                // Show canvas and hide message
                canvas.style.display = 'block';
                loadingDiv.remove();
                
                window.sleepChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: currentLang === 'es' ? 'Duraci√≥n de siestas (horas)' : 'Nap duration (hours)',
                            data: data.durations,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: currentLang === 'es' ? 'Horas' : 'Hours'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: currentLang === 'es' ? 'Fecha' : 'Date'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: currentLang === 'es' ? 'Duraci√≥n de siestas por d√≠a' : 'Daily nap duration'
                            }
                        }
                    }
                });
            }).catch(error => {
                // Hide canvas and show error message
                canvas.style.display = 'none';
                loadingDiv.className = 'text-center py-8 text-red-600';
                loadingDiv.textContent = `Error: ${error.message}`;
            });
        }

        async function loadGraphData() {
            const fromDate = document.getElementById('graphFrom').value;
            const toDate = document.getElementById('graphTo').value;
            
            let query = getUserCollection('sleepRecords')
                .orderBy('date', 'asc');
            
            if (fromDate && toDate) {
                query = query.where('date', '>=', fromDate)
                           .where('date', '<=', toDate);
            }
            
            const snapshot = await query.get();
            
            const labels = [];
            const durations = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                
                // Double-check user ownership for extra security
                if (data.userId && data.userId !== currentUser.uid) {
                    console.warn('Data belongs to different user, skipping');
                    return;
                }
                
                const start = new Date(`1970-01-01T${data.start}`);
                const end = new Date(`1970-01-01T${data.end}`);
                const duration = (end - start) / (1000 * 60 * 60); // hours
                
                labels.push(data.date);
                durations.push(Math.round(duration * 100) / 100); // round to 2 decimals
            });
            
            return { labels, durations };
        }

        // Language translations
        const translations = {
            es: {
                title: "Baby Siesta Tracker",
                tabNext: "Pr√≥xima siesta",
                tabInsert: "Insertar", 
                tabHist: "Hist√≥rico",
                tabGraph: "Gr√°fica",
                tabConfig: "Config",
                labelNacimiento: "Fecha de nacimiento del beb√©",
                labelFecha: "Fecha",
                labelInicio: "Hora inicio siesta",
                labelFin: "Hora fin siesta",
                labelComentarios: "Comentarios",
                labelDesperto: "Despert√≥ bien",
                btnGuardar: "Guardar",
                labelConfig: "Configuraci√≥n de Firebase (JSON)",
                btnSaveConfig: "Guardar configuraci√≥n",
                from: "Desde:",
                to: "Hasta:",
                load: "Cargar",
                calculating: "Calculando pr√≥xima siesta...",
                loading: "Cargando...",
                noData: "No hay datos disponibles",
                configSaved: "‚úÖ Configuraci√≥n guardada correctamente",
                dataSaved: "‚úÖ Datos guardados correctamente",
                noConnection: "No Firebase connection",
                timeError: "Hora de fin debe ser posterior a la de inicio",
                historyTableHeaders: {
                    date: "Fecha",
                    time: "Horario",
                    duration: "Duraci√≥n",
                    ageWeeks: "Edad (semanas)",
                    comments: "Comentarios",
                    goodWake: "Despert√≥ bien",
                    actions: "Acciones"
                },
                wokeUpWell: "S√≠",
                wokeUpBad: "No",
                loginText: "Iniciar con Google",
                logoutText: "Cerrar sesi√≥n",
                authRequiredText: "Inicia sesi√≥n con tu cuenta de Google para acceder a tus datos",
                userNotAuth: "Usuario no autenticado",
                delete: "Eliminar",
                deleteRecord: "Eliminar registro",
                confirmDelete: "¬øEst√°s seguro de que quieres eliminar este registro? Esta acci√≥n no se puede deshacer.",
                recordDeleted: "‚úÖ Registro eliminado correctamente"
            },
            en: {
                title: "Baby Siesta Tracker",
                tabNext: "Next Nap",
                tabInsert: "Insert",
                tabHist: "History", 
                tabGraph: "Chart",
                tabConfig: "Config",
                labelNacimiento: "Baby's birth date",
                labelFecha: "Date",
                labelInicio: "Nap start time",
                labelFin: "Nap end time", 
                labelComentarios: "Comments",
                labelDesperto: "Woke up well",
                btnGuardar: "Save",
                labelConfig: "Firebase Configuration (JSON)",
                btnSaveConfig: "Save configuration",
                from: "From:",
                to: "To:",
                load: "Load",
                calculating: "Calculating next nap...",
                loading: "Loading...",
                noData: "No data available",
                configSaved: "‚úÖ Configuration saved successfully",
                dataSaved: "‚úÖ Data saved successfully", 
                noConnection: "No Firebase connection",
                timeError: "End time must be after start time",
                historyTableHeaders: {
                    date: "Date",
                    time: "Time",
                    duration: "Duration",
                    ageWeeks: "Age (weeks)",
                    comments: "Comments",
                    goodWake: "Woke up well",
                    actions: "Actions"
                },
                wokeUpWell: "Yes",
                wokeUpBad: "No",
                loginText: "Sign in with Google",
                logoutText: "Sign out",
                authRequiredText: "Sign in with your Google account to access your data",
                userNotAuth: "User not authenticated",
                delete: "Delete",
                deleteRecord: "Delete record",
                confirmDelete: "Are you sure you want to delete this record? This action cannot be undone.",
                recordDeleted: "‚úÖ Record deleted successfully"
            }
        };

        function updateLanguage() {
            const lang = translations[currentLang];
            document.getElementById('titlePage').textContent = lang.title;
            document.getElementById('tabBtnNext').textContent = lang.tabNext;
            document.getElementById('tabBtnInsert').textContent = lang.tabInsert;
            document.getElementById('tabBtnHist').textContent = lang.tabHist;
            document.getElementById('tabBtnGraph').textContent = lang.tabGraph;
            document.getElementById('tabBtnConfig').textContent = lang.tabConfig;
            document.getElementById('labelNacimiento').textContent = lang.labelNacimiento;
            document.getElementById('labelFecha').textContent = lang.labelFecha;
            document.getElementById('labelInicio').textContent = lang.labelInicio;
            document.getElementById('labelFin').textContent = lang.labelFin;
            document.getElementById('labelComentarios').textContent = lang.labelComentarios;
            document.getElementById('labelDesperto').textContent = lang.labelDesperto;
            document.getElementById('btnGuardar').textContent = lang.btnGuardar;
            document.getElementById('labelConfig').textContent = lang.labelConfig;
            document.getElementById('saveConfigBtn').textContent = lang.btnSaveConfig;
            
            // Update connection status with current language
            if (window.firestoreDB) {
                updateConnectionStatus(true);
            } else {
                updateConnectionStatus(false);
            }
            
            // Update auth required text
            document.getElementById('authRequiredText').textContent = lang.authRequiredText;
            document.getElementById('loginText').textContent = lang.loginText;
            document.getElementById('logoutText').textContent = lang.logoutText;
            
            // Update date labels and restore values
            const histFromValue = document.getElementById('histFrom').value;
            const histToValue = document.getElementById('histTo').value;
            const graphFromValue = document.getElementById('graphFrom').value;
            const graphToValue = document.getElementById('graphTo').value;
            
            document.querySelector('label:has(#histFrom)').innerHTML = `${lang.from} <input type="date" id="histFrom" class="border rounded p-1" />`;
            document.querySelector('label:has(#histTo)').innerHTML = `${lang.to} <input type="date" id="histTo" class="border rounded p-1" />`;
            document.querySelector('label:has(#graphFrom)').innerHTML = `${lang.from} <input type="date" id="graphFrom" class="border rounded p-1" />`;
            document.querySelector('label:has(#graphTo)').innerHTML = `${lang.to} <input type="date" id="graphTo" class="border rounded p-1" />`;
            
            // Restore values
            document.getElementById('histFrom').value = histFromValue;
            document.getElementById('histTo').value = histToValue;
            document.getElementById('graphFrom').value = graphFromValue;
            document.getElementById('graphTo').value = graphToValue;
            
            // Update load buttons
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent === 'Cargar' || btn.textContent === 'Load') {
                    btn.textContent = lang.load;
                }
            });

            // Update any existing no-data messages
            const noDataElements = document.querySelectorAll('.text-center.py-8');
            noDataElements.forEach(element => {
                if (element.textContent.includes('No hay datos') || element.textContent.includes('No data')) {
                    element.textContent = lang.noData;
                } else if (element.textContent.includes('No Firebase connection')) {
                    element.textContent = lang.noConnection;
                } else if (element.textContent.includes('Cargando') || element.textContent.includes('Loading')) {
                    element.textContent = lang.loading;
                }
            });

            // Reload data with new language if user is authenticated
            if (window.firestoreDB && currentUser) {
                calcularProximaSiestaPonderada();
                loadHistorico();
                loadGraph();
            }
        }

        // Load saved configuration on page load
        function loadSavedConfig() {
            const defaultConfig = {
                "apiKey": "AIzaSyCVSLDNktqvmm-gjl0P1BTjJrUpq1bmXDo",
                "authDomain": "baby-sleep-tracker-725d1.firebaseapp.com",
                "projectId": "baby-sleep-tracker-725d1",
                "storageBucket": "baby-sleep-tracker-725d1.firebasestorage.app",
                "messagingSenderId": "451610840660",
                "appId": "1:451610840660:web:a4c3266cc8dd4ca37927c1"
            };

            const savedConfig = localStorage.getItem('firebaseConfig');
            let configToUse = savedConfig ? savedConfig : JSON.stringify(defaultConfig, null, 2);
            
            document.getElementById('firebaseConfig').value = configToUse;
            
            try {
                const config = JSON.parse(configToUse);
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(config);
                    window.firestoreDB = firebase.firestore();
                    
                    // Test the connection by attempting to get settings
                    window.firestoreDB.enableNetwork().then(() => {
                        console.log('Firebase connection successful');
                        updateConnectionStatus(true);
                        initializeAuth();
                    }).catch((err) => {
                        console.error('Firebase connection failed:', err);
                        updateConnectionStatus(false, err.message);
                    });
                    
                    // Save default config if none was saved
                    if (!savedConfig) {
                        localStorage.setItem('firebaseConfig', configToUse);
                    }
                } else {
                    updateConnectionStatus(true);
                    initializeAuth();
                }
            } catch (err) {
                console.error('Error loading config:', err);
                updateConnectionStatus(false, err.message);
            }
        }

        function updateConnectionStatus(connected, errorMessage = '') {
            const statusElement = document.getElementById('connectionStatus');
            if (!statusElement) return;
            
            if (connected) {
                statusElement.textContent = currentLang === 'es' ? '‚úÖ Conectado' : '‚úÖ Connected';
                statusElement.className = 'text-sm px-2 py-1 rounded bg-green-100 text-green-800';
            } else {
                statusElement.textContent = currentLang === 'es' ? '‚ùå Desconectado' : '‚ùå Disconnected';
                statusElement.className = 'text-sm px-2 py-1 rounded bg-red-100 text-red-800';
                if (errorMessage) {
                    statusElement.title = errorMessage;
                }
            }
        }

        // Modified Firebase configuration to include auth
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        if (saveConfigBtn) {
            saveConfigBtn.addEventListener('click', () => {
                const saveMsg = document.getElementById('saveMessage');
                saveMsg.textContent = '';
                try {
                    const configText = document.getElementById('firebaseConfig').value;
                    const config = JSON.parse(configText);
                    
                    // Initialize Firebase with Auth
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(config);
                        window.firestoreDB = firebase.firestore();
                        
                        // Test connection and then initialize auth
                        window.firestoreDB.enableNetwork().then(() => {
                            console.log('Firebase connection successful');
                            updateConnectionStatus(true);
                            initializeAuth();
                        }).catch((err) => {
                            console.error('Firebase connection failed:', err);
                            updateConnectionStatus(false, err.message);
                        });
                    } else {
                        updateConnectionStatus(true);
                    }
                    
                    localStorage.setItem('firebaseConfig', configText);
                    
                    saveMsg.textContent = translations[currentLang].configSaved;
                    saveMsg.classList.add('text-green-600');
                } catch (err) {
                    saveMsg.textContent = '‚ùå Error: ' + err.message;
                    saveMsg.classList.add('text-red-600');
                    updateConnectionStatus(false, err.message);
                }
            });
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved language or default to Spanish
            const savedLanguage = localStorage.getItem('selectedLanguage') || 'es';
            currentLang = savedLanguage;
            document.getElementById('languageSelect').value = currentLang;
            
            // Set initial status
            updateConnectionStatus(false, 'Initializing...');
            
            setDefaultValues();
            loadSavedConfig();
            
            // Language selector handler
            const languageSelect = document.getElementById('languageSelect');
            languageSelect.addEventListener('change', function() {
                currentLang = this.value;
                localStorage.setItem('selectedLanguage', currentLang);
                updateLanguage();
                setDefaultValues(); // Re-set default values with updated language
            });
            
            // Add auth event listeners
            document.getElementById('loginBtn').addEventListener('click', signInWithGoogle);
            document.getElementById('logoutBtn').addEventListener('click', signOut);
            
            // Birth date change handler (user-specific)
            const birthDateInput = document.getElementById('birthDate');
            birthDateInput.addEventListener('change', function() {
                if (currentUser) {
                    localStorage.setItem(`babyBirthDate_${currentUser.uid}`, this.value);
                    calcularProximaSiestaPonderada();
                }
            });
            
            // Add load button handlers
            document.getElementById('loadHistBtn').addEventListener('click', loadHistorico);
            document.getElementById('loadGraphBtn').addEventListener('click', loadGraph);
            
            // Set initial language
            updateLanguage();
            
            // Default to Config tab if no user is authenticated
            if (!currentUser) {
                // Switch to config tab by default
                document.querySelector('[data-tab="config"]').click();
            }
            
            // Auto-load data if Firebase is already configured and user is authenticated
            setTimeout(() => {
                if (window.firestoreDB && currentUser) {
                    calcularProximaSiestaPonderada();
                    loadHistorico();
                    loadGraph();
                }
            }, 500);
        });
    </script>
</body>

</html>