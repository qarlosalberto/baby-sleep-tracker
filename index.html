<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Sleep Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

    <div class="max-w-5xl mx-auto bg-white p-6 rounded shadow space-y-6">
        <div class="flex justify-between items-center">
            <h1 id="titlePage" class="text-xl font-bold">Seguimiento de siestas</h1>
            <select id="languageSelect" class="border border-gray-300 rounded px-2 py-1 w-32">
                <option value="es">üá™üá∏ Espa√±ol</option>
                <option value="en">üá¨üáß English</option>
            </select>
        </div>

        <div class="flex border-b">
            <button id="tabBtnNext"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-blue-600 text-blue-600 hover:bg-gray-100"
                data-tab="nextSiesta">Pr√≥xima siesta</button>
            <button id="tabBtnInsert"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-transparent hover:bg-gray-100"
                data-tab="insertar">Insertar</button>
            <button id="tabBtnHist"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-transparent hover:bg-gray-100"
                data-tab="historico">Hist√≥rico</button>
            <button id="tabBtnGraph"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-transparent hover:bg-gray-100"
                data-tab="grafica">Gr√°fica</button>
            <button id="tabBtnConfig"
                class="tab-btn px-4 py-2 text-gray-700 border-b-2 border-transparent hover:bg-gray-100"
                data-tab="config">Config</button>
        </div>

        <!-- Next Siesta -->
        <div id="tab-nextSiesta" class="tab-content">
            <p id="contentNext">Pr√≥xima siesta aqu√≠‚Ä¶</p>
        </div>

        <!-- History -->
        <div id="tab-historico" class="tab-content hidden">
            <div class="flex space-x-2 mb-4">
                <label class="text-sm">Desde: <input type="date" id="histFrom" class="border rounded p-1" /></label>
                <label class="text-sm">Hasta: <input type="date" id="histTo" class="border rounded p-1" /></label>
                <button id="loadHistBtn" class="px-2 py-1 bg-gray-200 rounded">Cargar</button>
            </div>
            <div id="contentHist" class="overflow-auto max-h-64 bg-gray-50 p-2 rounded">Hist√≥rico aqu√≠‚Ä¶</div>
        </div>

        <!-- Graph -->
        <div id="tab-grafica" class="tab-content hidden">
            <div class="flex space-x-2 mb-4">
                <label class="text-sm">Desde: <input type="date" id="graphFrom" class="border rounded p-1" /></label>
                <label class="text-sm">Hasta: <input type="date" id="graphTo" class="border rounded p-1" /></label>
                <button id="loadGraphBtn" class="px-2 py-1 bg-gray-200 rounded">Cargar</button>
            </div>
            <canvas id="sleepChart"></canvas>
        </div>

        <!-- Insert -->
        <div id="tab-insertar" class="tab-content space-y-4 hidden">
            <form id="sleepForm" class="space-y-4">
                <div>
                    <label id="labelNacimiento" class="block text-sm font-medium text-gray-700">Fecha de nacimiento del beb√©</label>
                    <input type="date" id="birthDate" required
                        class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
                </div>
                <div>
                    <label id="labelFecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="napDate" required
                        class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
                </div>
                <div>
                    <label id="labelInicio" class="block text-sm font-medium text-gray-700">Hora inicio siesta</label>
                    <input type="time" id="napStart" required
                        class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
                </div>
                <div>
                    <label id="labelFin" class="block text-sm font-medium text-gray-700">Hora fin siesta</label>
                    <input type="time" id="napEnd" required
                        class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
                </div>
                <div>
                    <label id="labelComentarios" class="block text-sm font-medium text-gray-700">Comentarios</label>
                    <textarea id="comments" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="goodWake" class="mr-2">
                    <label id="labelDesperto" for="goodWake" class="text-sm text-gray-700">Despert√≥ bien</label>
                </div>
                <button type="submit" id="btnGuardar"
                    class="px-4 py-2 rounded bg-blue-600 text-white font-medium hover:bg-blue-700 transition">Guardar</button>
                <p id="formMessage" class="text-sm mt-2"></p>
            </form>
        </div>

        <!-- Config -->
        <div id="tab-config" class="tab-content hidden">
            <label id="labelConfig" class="block text-sm font-medium text-gray-700 mb-2">Configuraci√≥n de Firebase
                (JSON)</label>
            <textarea id="firebaseConfig" rows="8" 
                class="w-full rounded border-2 border-gray-300 shadow-sm p-3 mb-4 font-mono text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder='{\n  "apiKey": "tu-api-key",\n  "authDomain": "tu-proyecto.firebaseapp.com",\n  "projectId": "tu-proyecto-id",\n  "storageBucket": "tu-proyecto.appspot.com",\n  "messagingSenderId": "123456789",\n  "appId": "tu-app-id"\n}'></textarea>
            <button id="saveConfigBtn"
                class="w-full px-4 py-2 rounded bg-green-600 text-white font-medium hover:bg-green-700 transition">Guardar
                configuraci√≥n</button>
            <p id="saveMessage" class="text-sm mt-2"></p>
        </div>
    </div>

    <script>
        // Function to set default values
        function setDefaultValues() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            // Current time
            const currentHours = String(now.getHours()).padStart(2, '0');
            const currentMinutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${currentHours}:${currentMinutes}`;

            // 30 minutes ago
            const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);
            const startHours = String(thirtyMinutesAgo.getHours()).padStart(2, '0');
            const startMinutes = String(thirtyMinutesAgo.getMinutes()).padStart(2, '0');
            const startTime = `${startHours}:${startMinutes}`;

            // Set birth date default (load from localStorage or use default)
            const savedBirthDate = localStorage.getItem('babyBirthDate');
            const defaultBirthDate = savedBirthDate || '2025-04-19';
            document.getElementById('birthDate').value = defaultBirthDate;

            // Set insert form defaults
            document.getElementById('napDate').value = today;
            document.getElementById('napStart').value = startTime;
            document.getElementById('napEnd').value = currentTime;

            // Set historical dates (yesterday to today)
            document.getElementById('histFrom').value = yesterday;
            document.getElementById('histTo').value = today;

            // Set graph dates (yesterday to today)
            document.getElementById('graphFrom').value = yesterday;
            document.getElementById('graphTo').value = today;
        }

        // Tab navigation by data-tab
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(btn => {
            btn.addEventListener('click', () => {
                // deactivate all
                tabs.forEach(b => {
                    b.classList.remove('border-blue-600', 'text-blue-600');
                    b.classList.add('text-gray-700', 'border-transparent');
                });
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                // activate clicked
                btn.classList.remove('text-gray-700', 'border-transparent');
                btn.classList.add('border-blue-600', 'text-blue-600');
                const target = document.getElementById(`tab-${btn.dataset.tab}`);
                if (target) target.classList.remove('hidden');
            });
        });

        // Insert form logic
        const sleepForm = document.getElementById('sleepForm');
        if (sleepForm) {
            sleepForm.addEventListener('submit', async e => {
                e.preventDefault();
                const formMsg = document.getElementById('formMessage');
                formMsg.textContent = '';
                try {
                    if (!window.firestoreDB) throw new Error('No Firebase connection');
                    const birthDate = document.getElementById('birthDate').value;
                    const date = document.getElementById('napDate').value;
                    const start = document.getElementById('napStart').value;
                    const end = document.getElementById('napEnd').value;
                    
                    // Save birth date to localStorage
                    localStorage.setItem('babyBirthDate', birthDate);
                    
                    // Calculate age in weeks
                    const birthDateTime = new Date(birthDate);
                    const napDateTime = new Date(date);
                    const ageInDays = Math.floor((napDateTime - birthDateTime) / (1000 * 60 * 60 * 24));
                    const ageInWeeks = Math.floor(ageInDays / 7);
                    
                    if (new Date(`1970-01-01T${end}`) <= new Date(`1970-01-01T${start}`)) {
                        throw new Error(translations[currentLang].timeError);
                    }
                    const commentsVal = document.getElementById('comments').value;
                    const good = document.getElementById('goodWake').checked;
                    await window.firestoreDB.collection('sleepRecords').add({ 
                        birthDate, 
                        date, 
                        start, 
                        end, 
                        comments: commentsVal, 
                        goodWake: good, 
                        ageInWeeks,
                        timestamp: new Date() 
                    });
                    formMsg.textContent = translations[currentLang].dataSaved;
                    formMsg.classList.add('text-green-600');
                    sleepForm.reset();
                    // Re-set default values after reset
                    setDefaultValues();
                    // Refresh views
                    calcularProximaSiestaPonderada();
                    loadHistorico();
                    loadGraph();
                } catch (err) {
                    formMsg.textContent = '‚ùå ' + err.message;
                    formMsg.classList.add('text-red-600');
                }
            });
        }

        // Firebase configuration logic
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        if (saveConfigBtn) {
            saveConfigBtn.addEventListener('click', () => {
                const saveMsg = document.getElementById('saveMessage');
                saveMsg.textContent = '';
                try {
                    const configText = document.getElementById('firebaseConfig').value;
                    const config = JSON.parse(configText);
                    
                    // Initialize Firebase
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(config);
                    }
                    window.firestoreDB = firebase.firestore();
                    
                    // Save config to localStorage
                    localStorage.setItem('firebaseConfig', configText);
                    
                    saveMsg.textContent = translations[currentLang].configSaved;
                    saveMsg.classList.add('text-green-600');
                    
                    // Load data after successful configuration
                    calcularProximaSiestaPonderada();
                    loadHistorico();
                    loadGraph();
                } catch (err) {
                    saveMsg.textContent = '‚ùå Error: ' + err.message;
                    saveMsg.classList.add('text-red-600');
                }
            });
        }

        // Load saved configuration on page load
        function loadSavedConfig() {
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                document.getElementById('firebaseConfig').value = savedConfig;
                try {
                    const config = JSON.parse(savedConfig);
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(config);
                    }
                    window.firestoreDB = firebase.firestore();
                } catch (err) {
                    console.error('Error loading saved config:', err);
                }
            }
        }

        // Historical data loading logic
        const loadHistBtn = document.getElementById('loadHistBtn');
        if (loadHistBtn) {
            loadHistBtn.addEventListener('click', loadHistorico);
        }

        // Graph data loading logic
        const loadGraphBtn = document.getElementById('loadGraphBtn');
        if (loadGraphBtn) {
            loadGraphBtn.addEventListener('click', loadGraph);
        }

        // Language translations
        const translations = {
            es: {
                title: "Seguimiento de siestas",
                tabNext: "Pr√≥xima siesta",
                tabInsert: "Insertar", 
                tabHist: "Hist√≥rico",
                tabGraph: "Gr√°fica",
                tabConfig: "Config",
                labelNacimiento: "Fecha de nacimiento del beb√©",
                labelFecha: "Fecha",
                labelInicio: "Hora inicio siesta",
                labelFin: "Hora fin siesta",
                labelComentarios: "Comentarios",
                labelDesperto: "Despert√≥ bien",
                btnGuardar: "Guardar",
                labelConfig: "Configuraci√≥n de Firebase (JSON)",
                btnSaveConfig: "Guardar configuraci√≥n",
                from: "Desde:",
                to: "Hasta:",
                load: "Cargar",
                calculating: "Calculando pr√≥xima siesta...",
                loading: "Cargando...",
                noData: "No hay datos disponibles",
                configSaved: "‚úÖ Configuraci√≥n guardada correctamente",
                dataSaved: "‚úÖ Datos guardados correctamente",
                noConnection: "No Firebase connection",
                timeError: "Hora de fin debe ser posterior a la de inicio",
                historyTableHeaders: {
                    date: "Fecha",
                    time: "Horario",
                    duration: "Duraci√≥n",
                    ageWeeks: "Edad (semanas)",
                    comments: "Comentarios",
                    goodWake: "Despert√≥ bien"
                },
                wokeUpWell: "S√≠",
                wokeUpBad: "No"
            },
            en: {
                title: "Nap Tracking",
                tabNext: "Next Nap",
                tabInsert: "Insert",
                tabHist: "History", 
                tabGraph: "Chart",
                tabConfig: "Config",
                labelNacimiento: "Baby's birth date",
                labelFecha: "Date",
                labelInicio: "Nap start time",
                labelFin: "Nap end time", 
                labelComentarios: "Comments",
                labelDesperto: "Woke up well",
                btnGuardar: "Save",
                labelConfig: "Firebase Configuration (JSON)",
                btnSaveConfig: "Save configuration",
                from: "From:",
                to: "To:",
                load: "Load",
                calculating: "Calculating next nap...",
                loading: "Loading...",
                noData: "No data available",
                configSaved: "‚úÖ Configuration saved successfully",
                dataSaved: "‚úÖ Data saved successfully", 
                noConnection: "No Firebase connection",
                timeError: "End time must be after start time",
                historyTableHeaders: {
                    date: "Date",
                    time: "Time",
                    duration: "Duration",
                    ageWeeks: "Age (weeks)",
                    comments: "Comments",
                    goodWake: "Woke up well"
                },
                wokeUpWell: "Yes",
                wokeUpBad: "No"
            }
        };

        let currentLang = 'es';

        function updateLanguage() {
            const lang = translations[currentLang];
            document.getElementById('titlePage').textContent = lang.title;
            document.getElementById('tabBtnNext').textContent = lang.tabNext;
            document.getElementById('tabBtnInsert').textContent = lang.tabInsert;
            document.getElementById('tabBtnHist').textContent = lang.tabHist;
            document.getElementById('tabBtnGraph').textContent = lang.tabGraph;
            document.getElementById('tabBtnConfig').textContent = lang.tabConfig;
            document.getElementById('labelNacimiento').textContent = lang.labelNacimiento;
            document.getElementById('labelFecha').textContent = lang.labelFecha;
            document.getElementById('labelInicio').textContent = lang.labelInicio;
            document.getElementById('labelFin').textContent = lang.labelFin;
            document.getElementById('labelComentarios').textContent = lang.labelComentarios;
            document.getElementById('labelDesperto').textContent = lang.labelDesperto;
            document.getElementById('btnGuardar').textContent = lang.btnGuardar;
            document.getElementById('labelConfig').textContent = lang.labelConfig;
            document.getElementById('saveConfigBtn').textContent = lang.btnSaveConfig;
            
            // Update date labels
            const histFromValue = document.getElementById('histFrom').value;
            const histToValue = document.getElementById('histTo').value;
            const graphFromValue = document.getElementById('graphFrom').value;
            const graphToValue = document.getElementById('graphTo').value;
            
            document.querySelector('label:has(#histFrom)').innerHTML = `${lang.from} <input type="date" id="histFrom" class="border rounded p-1" />`;
            document.querySelector('label:has(#histTo)').innerHTML = `${lang.to} <input type="date" id="histTo" class="border rounded p-1" />`;
            document.querySelector('label:has(#graphFrom)').innerHTML = `${lang.from} <input type="date" id="graphFrom" class="border rounded p-1" />`;
            document.querySelector('label:has(#graphTo)').innerHTML = `${lang.to} <input type="date" id="graphTo" class="border rounded p-1" />`;
            
            // Restore values
            document.getElementById('histFrom').value = histFromValue;
            document.getElementById('histTo').value = histToValue;
            document.getElementById('graphFrom').value = graphFromValue;
            document.getElementById('graphTo').value = graphToValue;
            
            // Update load buttons
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent === 'Cargar' || btn.textContent === 'Load') {
                    btn.textContent = lang.load;
                }
            });

            // Reload data with new language
            if (window.firestoreDB) {
                calcularProximaSiestaPonderada();
                loadHistorico();
            }
        }

        // Actual data loading functions
        async function calcularProximaSiestaPonderada() {
            const contentNext = document.getElementById('contentNext');
            const lang = translations[currentLang];
            
            if (!window.firestoreDB) {
                contentNext.textContent = lang.noConnection;
                return;
            }
            
            contentNext.textContent = lang.calculating;
            
            try {
                // Get saved birth date
                const savedBirthDate = localStorage.getItem('babyBirthDate') || '2025-04-19';
                const birthDateTime = new Date(savedBirthDate);
                const now = new Date();
                const currentAgeInWeeks = Math.floor((now - birthDateTime) / (1000 * 60 * 60 * 24 * 7));
                
                // Get last 10 nap records to calculate average
                const snapshot = await window.firestoreDB.collection('sleepRecords')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    contentNext.innerHTML = `
                        <div class="space-y-2">
                            <p class="text-sm text-gray-600">${currentLang === 'es' ? 'Edad actual' : 'Current age'}: ${currentAgeInWeeks} ${currentLang === 'es' ? 'semanas' : 'weeks'}</p>
                            <p>${lang.noData}</p>
                        </div>
                    `;
                    return;
                }
                
                let totalMinutes = 0;
                let count = 0;
                let lastNapTime = null;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const start = new Date(`1970-01-01T${data.start}`);
                    const end = new Date(`1970-01-01T${data.end}`);
                    const duration = (end - start) / (1000 * 60); // minutes
                    
                    totalMinutes += duration;
                    count++;
                    
                    if (!lastNapTime) {
                        lastNapTime = new Date(`${data.date}T${data.end}`);
                    }
                });
                
                const avgDuration = Math.round(totalMinutes / count);
                const avgHours = Math.floor(avgDuration / 60);
                const avgMins = avgDuration % 60;
                
                // Calculate next nap time based on age
                let napInterval = 3.5; // default for older babies
                
                if (currentAgeInWeeks <= 4) {
                    napInterval = 1.5; // Newborn: every 1.5 hours
                } else if (currentAgeInWeeks <= 12) {
                    napInterval = 2; // 1-3 months: every 2 hours
                } else if (currentAgeInWeeks <= 26) {
                    napInterval = 2.5; // 3-6 months: every 2.5 hours
                } else if (currentAgeInWeeks <= 52) {
                    napInterval = 3; // 6-12 months: every 3 hours
                }
                
                const nextNapTime = new Date(lastNapTime.getTime() + (napInterval * 60 * 60 * 1000));
                const nextNapFormatted = nextNapTime.toLocaleTimeString(currentLang === 'es' ? 'es-ES' : 'en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Calculate time until next nap
                const timeUntilNap = nextNapTime - now;
                const hoursUntil = Math.floor(timeUntilNap / (1000 * 60 * 60));
                const minutesUntil = Math.floor((timeUntilNap % (1000 * 60 * 60)) / (1000 * 60));
                
                let timeUntilText = '';
                if (timeUntilNap > 0) {
                    if (hoursUntil > 0) {
                        timeUntilText = `${hoursUntil}h ${minutesUntil}m`;
                    } else {
                        timeUntilText = `${minutesUntil}m`;
                    }
                    timeUntilText = currentLang === 'es' ? `en ${timeUntilText}` : `in ${timeUntilText}`;
                } else {
                    timeUntilText = currentLang === 'es' ? '¬°Ya es hora!' : 'It\'s time!';
                }
                
                contentNext.innerHTML = `
                    <div class="space-y-2">
                        <p class="text-sm text-gray-600">${currentLang === 'es' ? 'Edad actual' : 'Current age'}: ${currentAgeInWeeks} ${currentLang === 'es' ? 'semanas' : 'weeks'}</p>
                        <p><strong>${currentLang === 'es' ? 'Duraci√≥n promedio' : 'Average duration'}:</strong> ${avgHours}h ${avgMins}m</p>
                        <p><strong>${currentLang === 'es' ? 'Pr√≥xima siesta estimada' : 'Next estimated nap'}:</strong> ${nextNapFormatted} (${timeUntilText})</p>
                        <p class="text-sm text-gray-600">${currentLang === 'es' ? 'Basado en los √∫ltimos 10 registros y edad del beb√©' : 'Based on last 10 records and baby\'s age'}</p>
                    </div>
                `;
            } catch (error) {
                contentNext.textContent = `Error: ${error.message}`;
            }
        }

        async function loadHistorico() {
            const contentHist = document.getElementById('contentHist');
            const lang = translations[currentLang];
            
            if (!window.firestoreDB) {
                contentHist.textContent = lang.noConnection;
                return;
            }
            
            contentHist.textContent = lang.loading;
            
            try {
                const fromDate = document.getElementById('histFrom').value;
                const toDate = document.getElementById('histTo').value;
                
                let query = window.firestoreDB.collection('sleepRecords')
                    .orderBy('timestamp', 'desc');
                
                if (fromDate && toDate) {
                    const fromTimestamp = new Date(`${fromDate}T00:00:00`);
                    const toTimestamp = new Date(`${toDate}T23:59:59`);
                    query = query.where('timestamp', '>=', fromTimestamp)
                                 .where('timestamp', '<=', toTimestamp);
                }
                
                const snapshot = await query.limit(50).get();
                
                if (snapshot.empty) {
                    contentHist.textContent = lang.noData;
                    return;
                }
                
                // Create table with headers
                let html = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.date}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.time}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.duration}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.ageWeeks}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.goodWake}</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b">${lang.historyTableHeaders.comments}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                `;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const start = new Date(`1970-01-01T${data.start}`);
                    const end = new Date(`1970-01-01T${data.end}`);
                    const duration = Math.round((end - start) / (1000 * 60)); // minutes
                    const hours = Math.floor(duration / 60);
                    const mins = duration % 60;
                    
                    // Calculate age if birth date is available
                    let ageText = data.ageInWeeks ? `${data.ageInWeeks}` : '-';
                    if (!data.ageInWeeks && data.birthDate) {
                        const birthDateTime = new Date(data.birthDate);
                        const napDateTime = new Date(data.date);
                        const ageInDays = Math.floor((napDateTime - birthDateTime) / (1000 * 60 * 60 * 24));
                        const ageInWeeks = Math.floor(ageInDays / 7);
                        ageText = `${ageInWeeks}`;
                    }
                    
                    const goodWakeText = data.goodWake ? lang.wokeUpWell : lang.wokeUpBad;
                    const goodWakeClass = data.goodWake ? 'text-green-600' : 'text-red-600';
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 text-sm font-medium text-gray-900">${data.date}</td>
                            <td class="px-3 py-2 text-sm text-gray-700">${data.start} - ${data.end}</td>
                            <td class="px-3 py-2 text-sm text-gray-700">${hours}h ${mins}m</td>
                            <td class="px-3 py-2 text-sm text-gray-700">${ageText}</td>
                            <td class="px-3 py-2 text-sm ${goodWakeClass}">${goodWakeText}</td>
                            <td class="px-3 py-2 text-sm text-gray-600">${data.comments || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                contentHist.innerHTML = html;
            } catch (error) {
                contentHist.textContent = `Error: ${error.message}`;
            }
        }

        function loadGraph() {
            const canvas = document.getElementById('sleepChart');
            const lang = translations[currentLang];
            
            if (!canvas) return;
            
            if (!window.firestoreDB) {
                console.log('No Firebase connection for graph');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            // Clear previous chart if exists
            if (window.sleepChartInstance) {
                window.sleepChartInstance.destroy();
            }
            
            // Load real data
            loadGraphData().then(data => {
                window.sleepChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: currentLang === 'es' ? 'Duraci√≥n de siestas (horas)' : 'Nap duration (hours)',
                            data: data.durations,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: currentLang === 'es' ? 'Horas' : 'Hours'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: currentLang === 'es' ? 'Fecha' : 'Date'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: currentLang === 'es' ? 'Duraci√≥n de siestas por d√≠a' : 'Daily nap duration'
                            }
                        }
                    }
                });
            }).catch(error => {
                // Create placeholder chart on error
                window.sleepChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [currentLang === 'es' ? 'Sin datos' : 'No data'],
                        datasets: [{
                            label: currentLang === 'es' ? 'Duraci√≥n de siestas (horas)' : 'Nap duration (hours)',
                            data: [0],
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        }

        async function loadGraphData() {
            const fromDate = document.getElementById('graphFrom').value;
            const toDate = document.getElementById('graphTo').value;
            
            let query = window.firestoreDB.collection('sleepRecords')
                .orderBy('date', 'asc');
            
            if (fromDate && toDate) {
                query = query.where('date', '>=', fromDate)
                           .where('date', '<=', toDate);
            }
            
            const snapshot = await query.get();
            
            const labels = [];
            const durations = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const start = new Date(`1970-01-01T${data.start}`);
                const end = new Date(`1970-01-01T${data.end}`);
                const duration = (end - start) / (1000 * 60 * 60); // hours
                
                labels.push(data.date);
                durations.push(Math.round(duration * 100) / 100); // round to 2 decimals
            });
            
            return { labels, durations };
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved language or default to Spanish
            const savedLanguage = localStorage.getItem('selectedLanguage') || 'es';
            currentLang = savedLanguage;
            document.getElementById('languageSelect').value = currentLang;
            
            setDefaultValues();
            loadSavedConfig();
            
            // Language selector handler
            const languageSelect = document.getElementById('languageSelect');
            languageSelect.addEventListener('change', function() {
                currentLang = this.value;
                localStorage.setItem('selectedLanguage', currentLang);
                updateLanguage();
                setDefaultValues(); // Re-set default values with updated language
            });
            
            // Birth date change handler
            const birthDateInput = document.getElementById('birthDate');
            birthDateInput.addEventListener('change', function() {
                localStorage.setItem('babyBirthDate', this.value);
                // Recalculate next nap with new birth date
                if (window.firestoreDB) {
                    calcularProximaSiestaPonderada();
                }
            });
            
            // Set initial language
            updateLanguage();
            
            // Auto-load data if Firebase is already configured
            setTimeout(() => {
                if (window.firestoreDB) {
                    calcularProximaSiestaPonderada();
                    loadHistorico();
                    loadGraph();
                }
            }, 500);
        });
    </script>
</body>

</html>